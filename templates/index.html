<!DOCTYPE html>
<html>
  <head>
    <title>TripWatch</title>
     <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

     <link rel="stylesheet" href="{{ url_for('static', filename='index.css') }}">
  </head>
  <body>
    <h1>TripWatch</h1>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>

    <script>
      var map = L.map('map');
      var ROOT_SYD = {{default_pos}};

      var LeafIcon = L.Icon.extend({
        options: {
            shadowUrl: '{{ url_for('static', filename='carshadow.png') }}',
            iconSize:     [48, 48],
            shadowSize:   [40, 48],
            iconAnchor:   [32, 48],
            popupAnchor:  [0, -48],
            shadowAnchor: [4, 46]
        }
      });

      var car1 = new LeafIcon({iconUrl: '{{ url_for('static', filename='car1.png') }}'});
      var car2 = new LeafIcon({iconUrl: '{{ url_for('static', filename='car2.png') }}'});
      var car3 = new LeafIcon({iconUrl: '{{ url_for('static', filename='car3.png') }}'});
      var car4 = new LeafIcon({iconUrl: '{{ url_for('static', filename='car4.png') }}'});
      var car5 = new LeafIcon({iconUrl: '{{ url_for('static', filename='car5.png') }}'});
      var car6 = new LeafIcon({iconUrl: '{{ url_for('static', filename='car6.png') }}'});

      var icons = {
        "car1": car1,
        "car2": car2,
        "car3": car3,
        "car4": car4,
        "car5": car5,
        "car6": car6
      };

      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      const password = urlParams.get('password');

      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(function(position) {
          var lat = position.coords.latitude;
          var lon = position.coords.longitude;
          map.setView([lat, lon], 12);
          var self_marker = L.marker([lat, lon]).addTo(map);
          self_marker.bindPopup("<b>You are here</b>").openPopup();
        });
      } else {
        map.setView(ROOT_SYD, 12);
      }

      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);

      function fetchData() {
        navigator.geolocation.getCurrentPosition(function(position) {
          var lat = position.coords.latitude;
          var lon = position.coords.longitude;
          fetch(`{{ url_for('send_data') }}?password=${password}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ pos: [lat, lon] })
          });
        });
        fetch(`{{ url_for('get_data') }}?password=${password}`).then(response => response.json()).then(data => {
          map.eachLayer(function (layer) {
            if (layer instanceof L.Marker) {
              map.removeLayer(layer);
            }
          });

          data.forEach(item => {
            var marker = L.marker([item.pos[0], item.pos[1]], { icon: icons[item.car] }).addTo(map);
            marker.bindPopup("<b>" + item.user + "</b><br>Speed: ~" + item.speed + " km/h<br>Distance: ~" + item.diff + " km<br>Last Update: " + item.update_time);
          });
        });
      }

      fetchData();

      setInterval(fetchData, 120000);
    </script>
  </body>
</html>